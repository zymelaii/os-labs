<div align="center">
    <font size="6">西北工业大学计算机操作系统试点班实验环境说明书</font>
    <div align="right">
    <table>
        <tr>
            <td style="border:none;">作者</td>
            <td align="center" style="border:none;">项乔栋</td>
        </tr>
        <tr>
            <td style="border:none;">版本</td>
            <td align="center" style="border:none;">v0.3 (20240924)</td>
        </tr>
    </table>
    </div>
</div>

# 阅读之前

操作系统试点班计划使用 **windows**+**wsl2**+**qemu** 的组合作为标准实验环境。

需要注意的是，有且仅有 **qemu** 是该实验的必要组件，我们不建议你使用 **bochs** 或实体机来完成总体的实验内容，若你坚持如此，则应当自行处理之后可能会产生的一切问题。

本文旨在对相关范畴的新手进行实验环境搭建的指导，故如果你满足以下条件的任意一条，可自行斟酌是否跳过本文：

1. 我已经安装了 WSL 发行版并确定其支持于 WSL 2，且我对该发行版有着不算是单薄的操作经验
2. 我在虚拟机上安装了 linux 发行版，并在除了学校实验课程之外的内容上对其有着不算是单薄的操作经验
3. 我具备丰富的 linux 操作经验，并将其作为主操作系统用于日常使用
4. 我安装了双/多系统，其中一个是 linux 发行版，且我会时常切入该系统进行开发工作
5. 我已经在 Windows 上安装了 QEMU 并了解其基本使用方法，且能够独立且熟练地安装各类编译工具套件，并拥有自行构建第三方库或工具的能力

> 对于试点班实验的几乎全部内容，图形化界面并非是必要的。
>
> 但如果你考虑在最终的大实验中选题图形化界面实现相关内容，并且跳过了本文选择依靠自己的现有环境及经验来进行实验操作的话，我们建议你自行为 QEMU 配置好图形显示模式，如 GTK 或 VNC。
>
> 当然，如果你恰好使用的是 Ubuntu 的话，那便无需忧虑，它们是被默认支持的。

# 环境搭建

## 系统要求

在进行环境搭建之前，你应该确认你的系统至少为 Windows 10 21H2 及以上版本。

如果你很不幸地正在使用 Windows 7，或许你应当考虑使用虚拟机或在[阅读之前](#阅读之前)中及的其他方案来展开你的实验。

当然，升级为 Windows 10 或 11 也是不错的选择。

## 总览

- [WSL2 配置](#prepare-wsl2)
- [Ubuntu 20.04 安装](#install-ubuntu)
- [开发环境准备](#setup-dev-envs)
- [GUI 环境准备](#setup-gui-envs)
- [一切准备就绪](#ready-to-go)

## WSL2 配置 <span id="prepare-wsl2"/>

[\[MS-DOC\] 关于 WSL 的安装](https://learn.microsoft.com/en-us/windows/wsl/install)

[\[MS-DOC\] 关于 WSL 的 FAQ](https://learn.microsoft.com/zh-cn/windows/wsl/faq)

**总览**

- 进入电脑的 BIOS 面板，启用 CPU 虚拟化  VT-x
- 打开 **Windows 功能** 面板，启用特性 **Hyper-V**
- 打开 **Windows 功能** 面板，启用特性 **虚拟机平台**
- 打开 **Windows 功能** 面板，启用特性 **适用于 Linux 的 Windows 子系统**
- 重启
- 打开终端，执行 `wsl --help`，可以看到关于 wsl 的帮助信息

> 启用 Hyper-V 可能导致你的安卓模拟器无法使用，请自行协调

**详细说明**

> 作为一名决心进入试点班的学生，你应该具备最低限度的自主理解问题与自行解决问题的能力。
>
> 以下说明仅提供一定限度的参考，如果你无法理解并且无法自行依靠搜索引擎解决问题，或尝试绕过该问题寻找全新的解决方案，我想你应该认真思考选择进入试点班是否是正确的选择，思考自己究竟是在谋求自我提升还是在自我折磨。

### 1. **如何启用 CPU 虚拟化？**

该步骤需要进入到主板的 BIOS 面板启用，进入 BIOS 面板的方法为在开机后的系统启动界面狂按某个特定键——这些按键可能是 F2、F10、Esc、Del 中的任意一种，也可能是某种按键组合——直到进入一个看上去风格奇特的界面。

具体的按键根据计算机型号不同（具体来说是主板型号）而有所区别。如果你不了解且无法通过上述的任意按键进入，你应该学会在互联网上寻找答案，如“**联想拯救者 Y9000X 如何进入 BIOS？**”。

特别地，在 Windows 10 及以上版本，你也可以通过系统的**设置**面板的**恢复**目录中的**高级启动**项间接地进入 BIOS 面板而无需关心你的主板型号，具体操作办法请自行关键字搜索。

进入 BIOS 面板后，请自行探索面板的各个菜单及其子项，直到找到一个名为“VT-x”或“Virtualization Technology”或其他具有相关含义的的开关项。（AMD CPU 请寻找“AMD-V”或类似开关选项）

现在，启用它，然后**保存**并**退出**（你猜我为什么要加粗）。

### 2. **如何启用指定的 Windows 功能？**

选择以下任一方式进行操作：

**界面操作**

在 Windows 10 下，打开 **设置**-**应用**-**应用与功能**-**可选功能**-**更多 Windows 功能**，勾选指定的特性后确认，若提示需重启电脑，则立即重启。

Windows 11 类似。

**终端操作**

以**管理员模式**启动终端，执行：

```sh
dism.exe /online /enable-feature /featurename:Microsoft-Hyper-V /all /norestart
dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart
dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
```

## Ubuntu 20.04 安装 <span id="install-ubuntu"/>

### 1. **准备工作**

※ **我是第一次使用 WSL**

以**管理员身份**运行 Powershell 或 Command Prompt，执行：

```sh
wsl --install -d Ubuntu-20.04
```

你应该会得到以下输出：

```plain
正在安装: 虚拟机平台
已安装 虚拟机平台。
正在安装: 适用于 Linux 的 Windows 子系统已安装适用于 Linux 的 Windows 子系统。
正在下载: WSL 内核
正在安装: WSL 内核
已安装 WSL 内核。
正在下载: Ubuntu 20.04 LTS
请求的操作成功。直到重新启动系统前更改将不会生效。
```

完成以上操作后，重启电脑。

※ **我曾经使用过 WSL**

在终端运行 `wsl --install -d Ubuntu-20.04`。

你应该会得到以下输出

```plain
正在下载: Ubuntu 20.04 LTS
正在安装: Ubuntu 20.04 LTS
已安装 Ubuntu 20.04 LTS。
正在启动 Ubuntu 20.04 LTS…
```

> 若输出为乱码，请使用 **chcp 936** 更改代码页

### 2. **安装与启动**

你应当能够在应用列表的 **最近添加** 中找到 **Ubuntu 20.04 LTS**，运行它。

你应当得到一个弹窗并附带以下输出：

```plain
Installing, this may take a few minutes...
Please create a default UNIX user account. The username does not need to match your Windows username.
For more information visit: https://aka.ms/wslusers
Enter new UNIX username:
```

依次键入你的用户名（你不会输入中文的，对吧）、密码及密码确认。

> 密码输入是无回显模式，输入完回车就行。如果感觉自己打错了，可以狂按退格清空再重新输入。不过既然选择加入试点班，那么这些应该都是不必提醒的东西。

输入完成后，你应当会得到一个 **Welcome** 以及一个显著而简洁的绿色 prompt：

<font color="green">&lt;你的用户名&gt;@&lt;你的主机名&gt;</font>:<font color="#3b78ff">~</font>$

### 3. **确认及配置**

打开终端，执行：

```sh
wsl -l -v
```

你会得到已安装发行版及其状态的信息列表：

```plain
  NAME            STATE           VERSION
* Archlinux       Stopped         2
  Ubuntu-20.04    Running         2
```

设置默认启动的发行版：

```sh
wsl -s Ubuntu-20.04
```

更新指定发行版版本为 WSL 2：

```sh
wsl --set-version Ubuntu-20.04 2
```

> 通常这步不需要执行，但如果你发现安装的 Ubuntu-20.04 是 VERSION 1 的，那你可能遇到了什么意料之外的麻烦。

启用 Ubuntu-20.04：

```sh
wsl
```

> 通过应用启动当然也是可以的，不过这会默认使用丑陋单薄的 CMD 黑框框。
>
> 知晓如何从终端启动 WSL 是不可或缺的一件事，在后续的实验中，你大抵是会享受在 VSCode 的终端中启动 WSL 的。

## 开发环境准备 <span id="setup-dev-envs"/>

### 1. **安装**

- 换源（可选，但推荐）

```sh
sudo -i
bash <(curl -sSL https://linuxmirrors.cn/main.sh)
```

选择目标源并等待脚本执行结束后 Ctrl+D 回退到默认用户。

> 包管理器使用统一的仓库管理，而该仓库的源通常位于外网，这会使得国内访问极其不稳定乃至根本不可用。
>
> 换源的目的便是将包管理器使用的仓库源替换为国内的镜像源，从而使得包管理过程能够稳定进行。
>
> 简单来说，换源的目的有一大部分是为了解决网络问题。故如果你使用了代理工具并熟悉如何使用系统代理的话，换源就不再是必要的步骤。
>
> 还有一点需要注意的是，国内的镜像源并不总是提供完全一致的镜像内容，它们可能裁剪内容，可能新增内容，也可能会改造内容。如果你在仿照在线教程进行软件包安装的过程中遇到了安装失败的错误，你既应当考虑到本机系统的环境不兼容与包管理仓库本身的错误，也应当考虑到是否是当前使用的源与教程中使用的源不一致的问题。

- 配置 32 位兼容

```sh
sudo dpkg --add-architecture i386
sudo apt-get update
sudo apt-get install libc6:i386 libncurses5:i386 libstdc++6:i386
```

> OS 试点班除了大实验之外的全部内容的目标架构皆为 32-bit x86 i386，安装 32 位环境以确保能够编译出正确的 32 位目标文件。

- 安装开发环境

```sh
sudo apt-get install                      \
    gcc-multilib build-essential gdb nasm \
    qemu qemu-user qemu-system-x86
```

安装内容包括：

- 基本构建工具（含 git、make、GNU binutils 等常用工具）：build-essential
- 32 & 64 位 GCC：gcc-multilib
- 调试工具：gdb
- 汇编工具：nasm
- 虚拟机：qemu qemu-user qemu-system-x86

### 2. **检验**

对以下程序依次以 `--version` 参数执行，你应当能够正确执行并得到对应的版本号：

- gcc 9.4.0
- gdb 9.2
- make 4.2.1
- nasm 2.14.02
- git 2.25.1
- qemu-system-i386 4.2.1
- qemu-system-x86_64 4.2.1

执行以下程序，你应当能够正确执行并得到 `PASS` 输出：

```sh
fin=$(mktemp); fout=$(mktemp); echo 'main(){puts("PASS");}' > $fin; gcc -w -static -x c $fin -o $fout && $fout
```

## GUI 环境准备 <span id="setup-gui-envs"/>

默认状态的 wsl 内核并不支持图形化界面，考虑到大部分同学可能更习惯于图形化界面操作，此处提供 wsl 配置支持图形化界面的两种方案。

> 请注意，此处的图形化界面仅指代 QEMU 的 GUI DISPLAY，而并非推荐你去在 wsl 里装 vscode 等日常应用！
>
> 除非你真的清楚自己在做什么，请在 windows 下完成你的实验内容！不要在 wsl 里安装并运行什么奇奇怪怪的 GUI 应用！！！

**方案 1**

1. 执行 `wsl --version`，若命令输出了版本号，则已完成配置
2. 打开终端，执行 `wsl --update`，若提示更新成功，则已完成配置
3. 打开 **设置**-**更新与安全**-**Windows 更新**，获取并安装 Windows 更新
4. 重新执行步骤 2，若更新仍然失败，请转到方案 2

**方案 2**

1. *安装桌面环境 xfce4*

```shell
sudo apt-get install xfce4
```

2. *为 login shell 配置显示器参数*

```shell
sed -i '$a\\n# provide display server for x11 applications' ~/.bashrc
sed -i '$a\export DISPLAY=$(cat /etc/resolv.conf | grep nameserver | awk \x27{print $2; exit;}\x27):0.0' ~/.bashrc
sed -i '$a\export LIBGL_ALWAYS_INDIRECT=1' ~/.bashrc
```

> 两条 export 指令为 xfce4 提供了 display 相关的环境变量，用于在 windows 启动 GUI 应用。
>
> 以上指令将其写入 shell 启动时执行的配置文件 `~/.bashrc` 中，在登录时自动执行。
>
> 如果你使用的是 bash 之外的其他 shell，请自行向对应 profile 中写入环境变量添加。

3. *在 Windows 端安装 VcXsrv*

    [👉下载链接](https://sourceforge.net/projects/vcxsrv/)

4. *启动 VcXsrv*

    运行 VcXsrv 的 xlaunch.exe，以以下配置启动：

- Multiple windows
- Start no client
- Clipboard + Native opengl + Disable access control

5. *退出 wsl 并重新进入，配置完成*

> 此方案的基本原理是 wsl xfce4 通过 display server 通信，借由 windows 端的 VcXsrv 实现图形化界面显示。
>
> 故若需要启动 GUI 应用，你应当同学确保 dislay server 被正确配置（步骤 2）及 VcXsrv 已启动（步骤 4）。

## 一切准备就绪 <span id="ready-to-go"/>

到目前为止，你已经完成了完成实验的最基本的环境搭建。

但是考虑到一百个人里都难以有一个习惯于在终端中进行开发作业的人，一个不错的编码环境也是不可或缺的。

在这里，我们推荐你使用 VSCode 开展 OS 实验：

- 安装 VSCode
- 安装插件 ms-vscode-remote.remote-wsl
- `Ctrl+Shift+P` 呼出命令面板，选择 `Remote-WSL: New WSL Windows using Distro...` 连接到安装完成的 `Ubuntu-20.04` 发行版
- `Ctrl+K,Ctrl+O` 切换到开发目录

至此，你已经完成了实验环境的搭建，祝你实验愉快！

## 关于 Windows 与 WSL 的文件系统共享

**P1**

WSL 会默认将 Windows 的盘挂载在 `/mnt` 下，在 WSL 下，你可以轻松地访问 Windows 下的文件并进行读写（但是不建议你这么做）。

Windows 访问 WSL 要稍加复杂一些，但仍是非常便捷的。

你可以在资源管理器中进入到路径 `\\wsl$`，这里将显示所有已经启动的 WSL 发行版。

推荐的做法是将对目标发行版的文件夹**映射网络驱动器**，以便下次能够通过盘符快速访问。

对于该映射自网络文件夹的驱动器，主流 shell 一般都能够支持，但是由于其路径的特殊性，依旧不能够排除部分命令工具出现执行异常的情况。

故推荐在 WSL 端完成可能的复杂跨 fs 操作，而在 windows 端仅通过资源管理器进行简单的文件拷贝。

**P2**

实验过程中，可能会出现误操作导致挂载的盘被意外卸载而无法从 wsl 访问 windows 的情况。

此时仅需关停 wsl 并重启即可。

```sh
wsl --shutdown
wsl
```

## 其他资料

- [提问的智慧](https://github.com/ryanhanwu/How-To-Ask-Questions-The-Smart-Way/blob/main/README-zh_CN.md)
- [命令行的艺术](https://github.com/jlevy/the-art-of-command-line/blob/master/README-zh.md)
- [SSH Configuraion](https://confluence.atlassian.com/bitbucketserver/creating-ssh-keys-776639788.html)
- [Git Cheat Sheet](https://training.github.com/)
- [GDB Cheat Sheet](https://darkdust.net/files/GDB%20Cheat%20Sheet.pdf)
- [QEMU Cheat Sheet](https://wangziqi2013.github.io/article/2022/03/09/qemu-cheat-sheet.html)
- [Makefile Cheat Sheet](https://devhints.io/makefile)
- [Bash Cheat Sheet](https://devhints.io/bash)
- [Linux & Bash Cheat Sheet](https://github.com/trinib/Linux-Bash-Commands)
